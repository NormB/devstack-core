# ==============================================================================
# DevStack Core - Minimal Profile Environment Overrides
# ==============================================================================
#
# This file contains environment variable overrides for the MINIMAL profile.
# The minimal profile includes only essential services for Git hosting and
# basic development needs.
#
# SERVICES INCLUDED (5):
#   - vault:      Secrets management (required)
#   - postgres:   PostgreSQL database + Forgejo storage
#   - pgbouncer:  Connection pooling
#   - forgejo:    Git server
#   - redis-1:    Single Redis instance (standalone mode)
#
# RESOURCE USAGE:
#   - RAM:        ~2GB
#   - CPU:        2 cores recommended
#   - Disk:       ~5GB for volumes
#   - Startup:    ~20 seconds
#
# USAGE:
#   Source this file before starting services:
#   set -a; source configs/profiles/minimal.env; set +a
#   docker compose --profile minimal up -d
#
# Or use the management script:
#   ./devstack.py start --profile minimal
#
# ==============================================================================

# ------------------------------------------------------------------------------
# Redis Configuration - Standalone Mode
# ------------------------------------------------------------------------------
# In minimal profile, Redis runs as a single standalone instance (no cluster).
# This is simpler and uses less resources, suitable for basic caching needs.

# Disable Redis cluster mode
REDIS_CLUSTER_ENABLED=false

# Skip Redis cluster initialization
REDIS_CLUSTER_INIT_REQUIRED=false

# Single Redis instance configuration
REDIS_1_HOST_PORT=6379
REDIS_1_TLS_PORT=6390
REDIS_1_CLUSTER_PORT=16379

# Redis memory limit (reduced for minimal profile)
REDIS_MAX_MEMORY=128mb
REDIS_MAXMEMORY_POLICY=allkeys-lru

# Redis persistence (lighter for minimal)
REDIS_SAVE_ENABLED=true
REDIS_SAVE_INTERVAL="900 1 300 10 60 10000"
REDIS_APPENDONLY=yes
REDIS_APPENDFSYNC=everysec

# ------------------------------------------------------------------------------
# PostgreSQL Configuration - Reduced Connections
# ------------------------------------------------------------------------------
# Forgejo and basic development don't need many connections.

# Maximum number of connections (reduced from 100)
POSTGRES_MAX_CONNECTIONS=50

# Shared buffers (reduced from 256MB)
POSTGRES_SHARED_BUFFERS=128MB

# Effective cache size (reduced from 1GB)
POSTGRES_EFFECTIVE_CACHE_SIZE=512MB

# Work memory per operation (reduced from 8MB)
POSTGRES_WORK_MEM=4MB

# Maintenance work memory (reduced from 64MB)
POSTGRES_MAINTENANCE_WORK_MEM=32MB

# PostgreSQL TLS (disabled for minimal - local development only)
POSTGRES_ENABLE_TLS=false

# ------------------------------------------------------------------------------
# Vault Configuration - Faster Health Checks
# ------------------------------------------------------------------------------
# Reduced health check intervals for faster startup in minimal environment.

VAULT_HEALTH_INTERVAL=30s
VAULT_HEALTH_TIMEOUT=5s
VAULT_HEALTH_RETRIES=5
VAULT_HEALTH_START_PERIOD=20s

# Vault TLS (disabled for minimal)
VAULT_ENABLE_TLS=false

# ------------------------------------------------------------------------------
# Forgejo Configuration
# ------------------------------------------------------------------------------
# Git server configuration optimized for personal/small team use.

# Forgejo domain (use localhost for minimal profile)
FORGEJO_DOMAIN=localhost

# Forgejo HTTP port
FORGEJO_HTTP_PORT=3000

# Forgejo SSH port
FORGEJO_SSH_PORT=2222

# Forgejo runner (disabled for minimal - no CI/CD)
FORGEJO_RUNNER_ENABLED=false

# Forgejo database (uses PostgreSQL from minimal stack)
FORGEJO_DB_TYPE=postgres
FORGEJO_DB_HOST=postgres:5432

# ------------------------------------------------------------------------------
# Health Check Configuration - Faster Intervals
# ------------------------------------------------------------------------------
# Reduced health check intervals for smaller service count.

# PostgreSQL health checks
POSTGRES_HEALTH_INTERVAL=30s
POSTGRES_HEALTH_TIMEOUT=5s
POSTGRES_HEALTH_RETRIES=5
POSTGRES_HEALTH_START_PERIOD=20s

# Redis health checks
REDIS_HEALTH_INTERVAL=30s
REDIS_HEALTH_TIMEOUT=3s
REDIS_HEALTH_RETRIES=5
REDIS_HEALTH_START_PERIOD=15s

# Forgejo health checks
FORGEJO_HEALTH_INTERVAL=30s
FORGEJO_HEALTH_TIMEOUT=5s
FORGEJO_HEALTH_RETRIES=5
FORGEJO_HEALTH_START_PERIOD=30s

# ------------------------------------------------------------------------------
# Logging Configuration - Reduced Verbosity
# ------------------------------------------------------------------------------
# Less verbose logging for minimal profile.

# Log level (info is sufficient for minimal)
LOG_LEVEL=info

# Docker logging limits (smaller files)
DOCKER_LOG_MAX_SIZE=5m
DOCKER_LOG_MAX_FILE=2

# ------------------------------------------------------------------------------
# Resource Limits - Conservative Allocation
# ------------------------------------------------------------------------------
# Conservative resource limits for minimal profile.

# PostgreSQL resources
POSTGRES_MEMORY_LIMIT=1G
POSTGRES_MEMORY_RESERVATION=256M
POSTGRES_CPU_LIMIT=1.5

# Redis resources
REDIS_MEMORY_LIMIT=256M
REDIS_MEMORY_RESERVATION=128M
REDIS_CPU_LIMIT=0.5

# Vault resources
VAULT_MEMORY_LIMIT=256M
VAULT_MEMORY_RESERVATION=128M
VAULT_CPU_LIMIT=0.5

# Forgejo resources
FORGEJO_MEMORY_LIMIT=512M
FORGEJO_MEMORY_RESERVATION=256M
FORGEJO_CPU_LIMIT=1.0

# ------------------------------------------------------------------------------
# Feature Flags - Minimal Features
# ------------------------------------------------------------------------------
# Disable non-essential features for minimal profile.

# Metrics collection (disabled - no Prometheus in minimal)
ENABLE_METRICS=false

# Log aggregation (disabled - no Loki in minimal)
ENABLE_LOGS=false

# TLS/SSL (disabled for local development)
ENABLE_TLS=false

# Observability pipeline (disabled - no Vector in minimal)
ENABLE_OBSERVABILITY=false

# ------------------------------------------------------------------------------
# Network Configuration
# ------------------------------------------------------------------------------
# Network settings for minimal profile.

# Colima network address (enable for host access)
COLIMA_NETWORK_ADDRESS=true

# Service network subnet (default)
SERVICE_NETWORK_SUBNET=172.20.0.0/16

# ------------------------------------------------------------------------------
# Backup Configuration
# ------------------------------------------------------------------------------
# Backup settings optimized for minimal profile.

# Backup retention (shorter for minimal)
BACKUP_RETENTION_DAYS=7

# Backup schedule (less frequent)
BACKUP_SCHEDULE="0 2 * * 0"  # Weekly on Sunday at 2 AM

# Backup compression (enabled to save space)
BACKUP_COMPRESSION=true

# ------------------------------------------------------------------------------
# Performance Tuning
# ------------------------------------------------------------------------------
# Performance settings optimized for minimal resource usage.

# Disable connection pooling tuning (small connection count)
PGBOUNCER_DEFAULT_POOL_SIZE=5
PGBOUNCER_MAX_CLIENT_CONN=25

# Disable advanced PostgreSQL features
POSTGRES_AUTOVACUUM=on
POSTGRES_AUTOVACUUM_MAX_WORKERS=2

# Redis tuning
REDIS_TCP_BACKLOG=128
REDIS_TIMEOUT=0
REDIS_TCP_KEEPALIVE=300

# ------------------------------------------------------------------------------
# Development Settings
# ------------------------------------------------------------------------------
# Development-specific settings for minimal profile.

# Hot reload (disabled for stability)
ENABLE_HOT_RELOAD=false

# Debug mode (disabled for production-like behavior)
DEBUG_MODE=false

# Verbose errors (disabled for cleaner logs)
VERBOSE_ERRORS=false

# ------------------------------------------------------------------------------
# Security Settings - Development Defaults
# ------------------------------------------------------------------------------
# Security settings appropriate for local development.

# Allow weak passwords (local development only)
ALLOW_WEAK_PASSWORDS=true

# Disable rate limiting (local development)
ENABLE_RATE_LIMITING=false

# Session timeout (1 day for convenience)
SESSION_TIMEOUT=86400

# ------------------------------------------------------------------------------
# Notes
# ------------------------------------------------------------------------------
#
# 1. REDIS CLUSTER:
#    - In minimal profile, redis-1 runs in STANDALONE mode (not cluster)
#    - No cluster initialization needed
#    - Direct connection: redis-cli -h localhost -p 6379
#
# 2. RESOURCE USAGE:
#    - Total RAM: ~2GB (conservative estimates)
#    - vault: ~256MB
#    - postgres: ~1GB
#    - pgbouncer: ~50MB
#    - forgejo: ~512MB
#    - redis-1: ~256MB
#
# 3. STARTUP TIME:
#    - Expected: 15-25 seconds
#    - Vault: 5-10s to unseal
#    - PostgreSQL: 5-10s to initialize
#    - Others: 2-5s each
#
# 4. USE CASES:
#    - Personal Git repository hosting
#    - Simple CRUD application development
#    - Learning DevStack Core
#    - CI/CD pipelines (lightweight testing)
#
# 5. UPGRADING TO STANDARD:
#    To add more services (Redis cluster, MySQL, MongoDB, RabbitMQ):
#    docker compose --profile standard up -d
#    (This keeps minimal services running and adds standard services)
#
# ==============================================================================
