# ==============================================================================
# DevStack Core - Full Profile Environment Overrides
# ==============================================================================
#
# This file contains environment variable overrides for the FULL profile.
# The full profile includes the complete suite with all services plus
# comprehensive observability stack (Prometheus, Grafana, Loki, Vector).
#
# SERVICES INCLUDED (18):
#   All standard services (10) PLUS:
#   - prometheus:        Metrics collection and time-series database
#   - grafana:           Visualization dashboards
#   - loki:              Log aggregation system
#   - vector:            Unified observability data pipeline
#   - cadvisor:          Container resource monitoring
#   - redis-exporter-1:  Redis metrics for node 1
#   - redis-exporter-2:  Redis metrics for node 2
#   - redis-exporter-3:  Redis metrics for node 3
#
# RESOURCE USAGE:
#   - RAM:        ~6GB
#   - CPU:        4-6 cores recommended
#   - Disk:       ~15GB for volumes (metrics retention)
#   - Startup:    ~60 seconds
#
# USAGE:
#   Source this file before starting services:
#   set -a; source configs/profiles/full.env; set +a
#   docker compose --profile full up -d
#
# Or use the management script:
#   ./devstack.py start --profile full
#
# ==============================================================================

# ------------------------------------------------------------------------------
# Inherit Standard Profile Settings
# ------------------------------------------------------------------------------
# The full profile extends standard profile with observability services.
# All standard profile settings apply unless overridden below.

# Redis cluster enabled
REDIS_CLUSTER_ENABLED=true
REDIS_CLUSTER_INIT_REQUIRED=true

# Standard connection limits
POSTGRES_MAX_CONNECTIONS=100
MYSQL_MAX_CONNECTIONS=100
MONGODB_MAX_CONNECTIONS=100

# ------------------------------------------------------------------------------
# Observability Feature Flags
# ------------------------------------------------------------------------------
# Enable all observability features in full profile.

# Metrics collection (Prometheus)
ENABLE_METRICS=true

# Log aggregation (Loki)
ENABLE_LOGS=true

# Observability pipeline (Vector)
ENABLE_OBSERVABILITY=true

# Container monitoring (cAdvisor)
ENABLE_CONTAINER_MONITORING=true

# Redis metrics exporters
ENABLE_REDIS_EXPORTERS=true

# ------------------------------------------------------------------------------
# Prometheus Configuration
# ------------------------------------------------------------------------------
# Metrics collection and time-series database.

# Prometheus scrape interval (how often to collect metrics)
PROMETHEUS_SCRAPE_INTERVAL=15s

# Prometheus evaluation interval (how often to evaluate rules)
PROMETHEUS_EVALUATION_INTERVAL=15s

# Prometheus data retention time
PROMETHEUS_RETENTION_TIME=15d

# Prometheus retention size
PROMETHEUS_RETENTION_SIZE=10GB

# Prometheus web port
PROMETHEUS_PORT=9090

# Prometheus external URL
PROMETHEUS_EXTERNAL_URL=http://localhost:9090

# ------------------------------------------------------------------------------
# Grafana Configuration
# ------------------------------------------------------------------------------
# Visualization dashboards for metrics and logs.

# Grafana HTTP port
GRAFANA_PORT=3001

# Grafana admin credentials (change these!)
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin

# Grafana data source (Prometheus)
GRAFANA_DATASOURCE_PROMETHEUS_URL=http://prometheus:9090

# Grafana data source (Loki)
GRAFANA_DATASOURCE_LOKI_URL=http://loki:3100

# Grafana install plugins
GRAFANA_INSTALL_PLUGINS=true

# Grafana allow embedding
GRAFANA_ALLOW_EMBEDDING=true

# ------------------------------------------------------------------------------
# Loki Configuration
# ------------------------------------------------------------------------------
# Log aggregation system.

# Loki HTTP port
LOKI_PORT=3100

# Loki retention period (31 days)
LOKI_RETENTION_PERIOD=744h

# Loki chunk target size
LOKI_CHUNK_TARGET_SIZE=1572864

# Loki max chunk age
LOKI_MAX_CHUNK_AGE=2h

# Loki ingester lifecycle
LOKI_INGESTER_LIFECYCLER=memberlist

# ------------------------------------------------------------------------------
# Vector Configuration
# ------------------------------------------------------------------------------
# Unified observability data pipeline.

# Vector log level
VECTOR_LOG_LEVEL=info

# Vector API port
VECTOR_API_PORT=8686

# Vector Prometheus sink
VECTOR_PROMETHEUS_ENABLED=true
VECTOR_PROMETHEUS_ENDPOINT=http://prometheus:9090/api/v1/write

# Vector Loki sink
VECTOR_LOKI_ENABLED=true
VECTOR_LOKI_ENDPOINT=http://loki:3100

# Vector PostgreSQL metrics
VECTOR_POSTGRES_METRICS_ENABLED=true
VECTOR_POSTGRES_METRICS_INTERVAL=60s

# Vector MySQL metrics
VECTOR_MYSQL_METRICS_ENABLED=true
VECTOR_MYSQL_METRICS_INTERVAL=60s

# Vector MongoDB metrics
VECTOR_MONGODB_METRICS_ENABLED=true
VECTOR_MONGODB_METRICS_INTERVAL=60s

# Vector Docker log collection
VECTOR_DOCKER_LOGS_ENABLED=true

# ------------------------------------------------------------------------------
# cAdvisor Configuration
# ------------------------------------------------------------------------------
# Container resource monitoring.

# cAdvisor HTTP port
CADVISOR_PORT=8080

# cAdvisor housekeeping interval
CADVISOR_HOUSEKEEPING_INTERVAL=30s

# cAdvisor storage duration
CADVISOR_STORAGE_DURATION=2m

# ------------------------------------------------------------------------------
# Redis Exporter Configuration
# ------------------------------------------------------------------------------
# Prometheus exporters for Redis nodes.

# Redis exporter ports
REDIS_EXPORTER_1_PORT=9121
REDIS_EXPORTER_2_PORT=9122
REDIS_EXPORTER_3_PORT=9123

# Redis exporter scrape interval
REDIS_EXPORTER_SCRAPE_INTERVAL=15s

# Redis exporter check keys
REDIS_EXPORTER_CHECK_KEYS=*

# Redis exporter check single keys
REDIS_EXPORTER_CHECK_SINGLE_KEYS=true

# ------------------------------------------------------------------------------
# Health Check Configuration
# ------------------------------------------------------------------------------
# Standard health check intervals for all services.

# Core services
POSTGRES_HEALTH_INTERVAL=60s
MYSQL_HEALTH_INTERVAL=60s
MONGODB_HEALTH_INTERVAL=60s
REDIS_HEALTH_INTERVAL=60s
RABBITMQ_HEALTH_INTERVAL=60s
VAULT_HEALTH_INTERVAL=60s
FORGEJO_HEALTH_INTERVAL=60s

# Observability services
PROMETHEUS_HEALTH_INTERVAL=30s
PROMETHEUS_HEALTH_TIMEOUT=5s
PROMETHEUS_HEALTH_RETRIES=5
PROMETHEUS_HEALTH_START_PERIOD=20s

GRAFANA_HEALTH_INTERVAL=30s
GRAFANA_HEALTH_TIMEOUT=5s
GRAFANA_HEALTH_RETRIES=5
GRAFANA_HEALTH_START_PERIOD=30s

LOKI_HEALTH_INTERVAL=30s
LOKI_HEALTH_TIMEOUT=5s
LOKI_HEALTH_RETRIES=5
LOKI_HEALTH_START_PERIOD=20s

# ------------------------------------------------------------------------------
# Logging Configuration
# ------------------------------------------------------------------------------
# Enhanced logging for observability.

# Log level (debug for troubleshooting)
LOG_LEVEL=info

# Docker logging (larger for full profile)
DOCKER_LOG_MAX_SIZE=20m
DOCKER_LOG_MAX_FILE=5

# Structured logging
LOG_FORMAT=json

# Include timestamps
LOG_TIMESTAMPS=true

# ------------------------------------------------------------------------------
# Resource Limits - Enhanced Allocation
# ------------------------------------------------------------------------------
# Enhanced resource limits for full observability stack.

# PostgreSQL resources
POSTGRES_MEMORY_LIMIT=2G
POSTGRES_MEMORY_RESERVATION=512M
POSTGRES_CPU_LIMIT=2

# MySQL resources
MYSQL_MEMORY_LIMIT=1G
MYSQL_MEMORY_RESERVATION=256M
MYSQL_CPU_LIMIT=1

# MongoDB resources
MONGODB_MEMORY_LIMIT=1G
MONGODB_MEMORY_RESERVATION=256M
MONGODB_CPU_LIMIT=1

# Redis resources (per node)
REDIS_MEMORY_LIMIT=512M
REDIS_MEMORY_RESERVATION=256M
REDIS_CPU_LIMIT=0.5

# RabbitMQ resources
RABBITMQ_MEMORY_LIMIT=512M
RABBITMQ_MEMORY_RESERVATION=256M
RABBITMQ_CPU_LIMIT=1

# Vault resources
VAULT_MEMORY_LIMIT=512M
VAULT_MEMORY_RESERVATION=128M
VAULT_CPU_LIMIT=0.5

# Forgejo resources
FORGEJO_MEMORY_LIMIT=1G
FORGEJO_MEMORY_RESERVATION=256M
FORGEJO_CPU_LIMIT=1.0

# Prometheus resources
PROMETHEUS_MEMORY_LIMIT=1G
PROMETHEUS_MEMORY_RESERVATION=512M
PROMETHEUS_CPU_LIMIT=1.0

# Grafana resources
GRAFANA_MEMORY_LIMIT=512M
GRAFANA_MEMORY_RESERVATION=256M
GRAFANA_CPU_LIMIT=0.5

# Loki resources
LOKI_MEMORY_LIMIT=512M
LOKI_MEMORY_RESERVATION=256M
LOKI_CPU_LIMIT=0.5

# Vector resources
VECTOR_MEMORY_LIMIT=512M
VECTOR_MEMORY_RESERVATION=256M
VECTOR_CPU_LIMIT=0.5

# cAdvisor resources
CADVISOR_MEMORY_LIMIT=256M
CADVISOR_MEMORY_RESERVATION=128M
CADVISOR_CPU_LIMIT=0.25

# Redis exporters (per exporter)
REDIS_EXPORTER_MEMORY_LIMIT=128M
REDIS_EXPORTER_MEMORY_RESERVATION=64M
REDIS_EXPORTER_CPU_LIMIT=0.1

# ------------------------------------------------------------------------------
# Network Configuration
# ------------------------------------------------------------------------------
# Network settings for full profile.

COLIMA_NETWORK_ADDRESS=true
SERVICE_NETWORK_SUBNET=172.20.0.0/16

# ------------------------------------------------------------------------------
# Backup Configuration
# ------------------------------------------------------------------------------
# Enhanced backup for full profile.

BACKUP_RETENTION_DAYS=30
BACKUP_SCHEDULE="0 2 * * *"  # Daily at 2 AM
BACKUP_COMPRESSION=true
BACKUP_POSTGRES=true
BACKUP_MYSQL=true
BACKUP_MONGODB=true

# Backup metrics and dashboards
BACKUP_PROMETHEUS=true
BACKUP_GRAFANA=true

# ------------------------------------------------------------------------------
# Performance Tuning
# ------------------------------------------------------------------------------
# Performance settings optimized for full observability workload.

# PgBouncer
PGBOUNCER_POOL_MODE=transaction
PGBOUNCER_DEFAULT_POOL_SIZE=10
PGBOUNCER_MAX_CLIENT_CONN=100

# PostgreSQL
POSTGRES_AUTOVACUUM=on
POSTGRES_AUTOVACUUM_MAX_WORKERS=3
POSTGRES_SHARED_PRELOAD_LIBRARIES=pg_stat_statements

# Prometheus query optimization
PROMETHEUS_QUERY_MAX_CONCURRENCY=20
PROMETHEUS_QUERY_TIMEOUT=2m

# Grafana caching
GRAFANA_CACHING_ENABLED=true

# ------------------------------------------------------------------------------
# Development Settings
# ------------------------------------------------------------------------------
# Development settings for full profile.

ENABLE_HOT_RELOAD=false
DEBUG_MODE=false
VERBOSE_ERRORS=true

# ------------------------------------------------------------------------------
# Security Settings
# ------------------------------------------------------------------------------
# Security settings for full profile.

ALLOW_WEAK_PASSWORDS=true
ENABLE_RATE_LIMITING=false
SESSION_TIMEOUT=28800

# TLS/SSL (optional, disabled by default)
ENABLE_TLS=false

# ------------------------------------------------------------------------------
# Grafana Dashboards
# ------------------------------------------------------------------------------
# Pre-configured dashboards available at http://localhost:3001
#
# 1. System Overview
#    - Container resource usage (CPU, memory, network)
#    - Service health status
#    - System-wide metrics
#
# 2. PostgreSQL Dashboard
#    - Connection counts and pool status
#    - Query performance
#    - Database size and growth
#    - Slow query log
#
# 3. MySQL Dashboard
#    - Connection statistics
#    - Query cache hit rate
#    - InnoDB metrics
#    - Slow query log
#
# 4. MongoDB Dashboard
#    - Operations per second
#    - Connection pool
#    - WiredTiger cache
#    - Replication lag (if applicable)
#
# 5. Redis Cluster Dashboard
#    - Per-node metrics
#    - Cluster health and slot distribution
#    - Memory usage and evictions
#    - Command statistics
#
# 6. RabbitMQ Dashboard
#    - Queue depths and rates
#    - Message publish/consume rates
#    - Connection and channel counts
#    - Memory and disk usage
#
# 7. Container Metrics (cAdvisor)
#    - Per-container CPU, memory, network
#    - Resource limits and usage
#    - Container lifecycle events
#
# Default credentials:
#   Username: admin
#   Password: admin
#   (Change these in production!)
#
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Notes
# ------------------------------------------------------------------------------
#
# 1. RESOURCE USAGE:
#    - Total RAM: ~6GB
#    - Core services: ~4GB
#    - Observability: ~2GB
#    - Disk: ~15GB (with 15 days metrics retention)
#
# 2. STARTUP TIME:
#    - Expected: 50-70 seconds
#    - Core services: 40-50s
#    - Observability: 10-20s additional
#    - Prometheus initial scrape: 15-30s
#
# 3. METRICS RETENTION:
#    - Prometheus: 15 days (configurable)
#    - Loki logs: 31 days (configurable)
#    - Adjust PROMETHEUS_RETENTION_TIME for longer retention
#
# 4. DISK SPACE:
#    - Prometheus: ~100-200MB/day (depends on cardinality)
#    - Loki: ~50-100MB/day (depends on log volume)
#    - Plan for ~5-10GB for 15 days retention
#
# 5. PERFORMANCE IMPACT:
#    - Metrics collection: ~5% CPU overhead
#    - Log aggregation: ~2-3% CPU overhead
#    - Acceptable for development, test before production use
#
# 6. USE CASES:
#    - Performance testing and optimization
#    - Production troubleshooting simulation
#    - Understanding resource usage patterns
#    - Learning observability best practices
#    - Load testing with real-time metrics
#
# 7. DOWNGRADING TO STANDARD:
#    To remove observability and save resources:
#    docker compose down  # Stop all
#    docker compose --profile standard up -d  # Start only standard
#
# ==============================================================================
